FROM bitnami/spark:3.4

USER root

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        procps \
        python3-pip \
        python3-dev \
        default-jdk \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set JAVA_HOME
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64
ENV PATH=$JAVA_HOME/bin:$PATH

# Create directories and set permissions
RUN mkdir -p /home/hdb/work /home/hdb/data && \
    chown -R 1001:1001 /home/hdb

# Switch to non-root user (bitnami spark image uses 1001)
USER 1001
WORKDIR /home/hdb

# Ensure local bin is in PATH
ENV PATH="/home/hdb/.local/bin:${PATH}"

# Install Python packages
RUN pip install --no-cache-dir --user \
    jupyter \
    jupyterlab \
    pandas \
    findspark

# The Spark environment variables are already set by the base image
ENV PYSPARK_PYTHON=python3
ENV PYSPARK_DRIVER_PYTHON=python3
ENV SPARK_MASTER=spark://spark-master:7077
ENV SPARK_DRIVER_MEMORY=1g
ENV SPARK_EXECUTOR_MEMORY=1g

# Set up Jupyter
RUN mkdir -p /home/hdb/.jupyter

RUN echo "c.NotebookApp.base_url = '/jupyter'" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN echo "c.NotebookApp.allow_origin = '*'" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN echo "c.NotebookApp.ip = '0.0.0.0'" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN echo "c.NotebookApp.allow_remote_access = True" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN echo "c.NotebookApp.disable_check_xsrf = True" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN python3 -c "from jupyter_server.auth import passwd; print(passwd('1_Abc_123', 'sha1'))" > /tmp/sha1.txt
RUN echo "c.NotebookApp.password = u'$(cat /tmp/sha1.txt)'" >> /home/hdb/.jupyter/jupyter_notebook_config.py
RUN rm /tmp/sha1.txt

EXPOSE 8888
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]